---
title: 微信小程序架构的研究
date: 2019-03-17 16:30:01
tags: [微信小程序]
---
# 什么是微信小程序？
微信小程序是一种hybird app（混合模式移动应用），介于web app和native app之间的app，既具有web app跨平台开发的优势，又具有native app良好的用户交互体验。
# 微信小程序为什么这么快？
打开小程序时，Native预先加载一个WebView。当打开指定页面时，用默认数据直接渲染，请求数据返回时局部更新。
# 小程序架构
## WebView是什么？
WebView是手机中内置的一款高性能WebKit内核浏览器，没有提供地址栏和导航栏，WebView只是单纯的展示一个网页界面。
## 什么是nwjs？
简单是说就是Node + WebKit，Node提供给我们本地api能力，而WebKit提供给我们web能力，两者结合就能让我们使用JS + HTML实现本地应用程序。
## 视图层与逻辑层
微信小程序框架由两个WebView组成，分为视图层（View）和逻辑层（App Service）。视图层使用WebView渲染。逻辑层可理解为一个单独用于逻辑处理的页面，使用JSCore运行。逻辑层具体的运行环境如下：
> IOS - JavaScriptCore
> Android - X5 JS解析器
> DevTool - nwjs Chrome 内核

视图层和逻辑层通过系统层的JSBridage进行通信，逻辑层把数据变化通知到视图层，触发视图层页面更新，视图层把触发的事件通知到逻辑层进行业务处理。

![](/images/wx/wx01.jpg)

这种结构完全隔开了视图层和逻辑层，和Vue.js和React有本质区别。小程序的逻辑层和视图层是运行在两个WebView中的，而后面的框架都是运行在一个WebView中的。优点在于视图层和逻辑层并行处理，避免了单线程模式下逻辑层卡顿引起的首屏渲染过长，完全采用数据驱动的模式，不提供直接操作DOM的接口，使用Virtual DOM，进行局部更新。坏处在于不能灵活操作DOM，复杂效果无法实现，且页面大小、打开页面的数量都受限制，数据传输需经过序列化和反序列化，用时较长。
# 小程序启动、更新和运行机制
## 冷启动与热启动
小程序启动分为冷启动和热启动两种。   
冷启动指用户首次打开或小程序被微信销毁后再次打开的情形，此时小程序需重新启动。   
热启动指用户已打开小程序，在一段时间内重新打开该小程序，此时无需重新启动，只需将小程序从后台态切换到前台即可。
## 小程序的更新机制
小程序冷启动时若发现有新版本，则会异步从CDN下载新版本的代码包，并同时使用本地已存在的代码包进行运行。下载完成后，下次冷启动时才会使用最新的代码包。若需要马上应用最新版本，可以使用`wx.getUpdateManage`进行处理。
## 小程序的运行机制
小程序没有重启的机制。小程序进入后台后，会在一定时间内保持运行状态，超过一定时间（5分钟）后会被微信主动销毁。当短时间（5s）内收到多次系统内存告警时，不管小程序是在前台还是后台，微信都会销毁小程序。   

![](/images/wx/wx02.png)

# 常见优化建议
## 避免频繁使用setData
经过上面的学习我们知道，小程序的视图层和逻辑层是完全分离的，其通信完全依赖JSBridge，因此数据到达视图层并不是实时的。所以毫秒级地使用setData刷新数据会造成页面卡顿。一次性传输过多数据会造成增大脚本的编译事件，造成逻辑层的滞后。另外，大量的图片资源可能会导致内存告警，从而触发微信回收小程序。
## 预先加载数据
小程序在启动时，会直接将所有页面逻辑代码加载进内存，即使是暂时没有用到的页面也一样。页面跳转后，上一级页面的逻辑代码也不会从内存中消失，跳转后的页面甚至可以直接访问上一级页面中的数据。为了减少页面跳转加载的延时，常常在上一级页面就开始请求数据，以便在跳转后直接使用。

# 参考链接
* [http://www.bbs0101.com/archives/1495.html](http://www.bbs0101.com/archives/1495.html)
* [https://juejin.im/post/5afd136551882542682e6ad7](https://juejin.im/post/5afd136551882542682e6ad7)
* [https://cloud.tencent.com/developer/article/1029663](https://cloud.tencent.com/developer/article/1029663)