---
title: 计算机网络：自顶向下方法读书笔记（四）
date: 2019-12-18 20:01:09
tags: [ 计算机网络, IP ]
---
本章我们来到了网络层。与运输层不同, 网络层存在于处在网络内部的每一台主机和路由器上。
网络层比较复杂, 可以分为两个相互独立但共同作用的部分: **数据平面**和**控制平面**。其基础协议是 IP 协议。本章主要涉及**网络层数据平面的相关知识。**
本章主要回答下面这些问题:
* 网络层数据平面的功能是什么?
* 路由器是如何实现网络层数据平面的功能的?
* 传统的基于 IP 的转发是如何实现的?
* 更为一般的转发是如何实现的?

# 网络层概述
我们将网络层使用的包称为`数据报(datagram)`。

网络层数据平面与控制平面的功能:
* 数据平面的功能: 转发。
* 控制平面的功能: 控制向哪里转发。这个功能还有一个高大上的名字, 叫路由选择。

`转发(forwarding)`和`路由选择(routing)`之间的区别是:
* **转发**指的是将一个数据报从一个链路转发到另一个链路的动作, 时间多为几纳秒, 通常用硬件来实现。
* **路由选择**是指确定数据报从发送端到接收端的路径的处理过程, 时间多为几秒, 通常用软件来实现。

为了实现控制平面的功能, 需要在路由器中存放一个`转发表(forwarding table)`。转发表会告知路由器具有特定首部值的数据报应该向哪条链路进行转发。

转发表一般有两种定义方式:
* 路由器与路由器之间通过路由选择协议交换包含路由信息的报文, 从而生成转发表。
在这种方式中, 路由器既实现了数据平面的功能, 也实现了控制平面的功能。
* 远程控制器计算转发表, 并向路由器进行分发。远程控制器存放在数据中心中, 由第三方或 ISP 进行管理。
通过这种方式, 路由器和远程控制器一起, 构成了一个实现了网络层所有功能的网络。由于这种网络的行为是通过远程控制器中的软件计算出来的, 因此将这样的网络称为`软件定义(的)网络(SDN, Software-Defined Networking)`。
在这种方式中, 路由器仅实现了数据平面的功能, 控制平面的功能由远程控制器实现。

**网络层提供的是尽力而为的服务(best-effort service)。**也就是说, 网络层不对数据报正确交付做任何承诺!

# 路由器工作原理
本节主要回答了路由器是如何将数据报从入链路转发到合适的出链路的。

## 路由器的结构
一个路由器的结构可以按照数据平面和控制平面来划分, 共分为四部分。
* 数据平面（由硬件实现）: 输入端口、交换结构、输出端口。
 要求纳秒级别, 因此无法用软件实现。
* 控制平面（由软件实现）: 路由选择处理器。

控制分组（如带有转发表信息的分组）由输入端口转发到路由选择处理器，路由选择器根据分组内容改变路由器行为。

## 基于目的地的分组转发
路由器转发一个分组时，会出现以下两种情况：
* 根据目的地转发。
* 根据其他通用的分组首部字段转发（通用分组转发）。

todo 补上 4.4 节的标题
**本节只讨论根据目的地转发分组的情况。**通用分组转发参见 4.4

如何避免每个分组进入输入端口后都调用一次路由选择处理器？
在交换结构与输入端口之间放置`线路卡`，路由选择处理器会将转发表复制到线路卡中。
当分组进入端口时，便可以根据线路卡中的转发表，在本地判断分组应该向哪个链路进行转发。

下面讨论在基于目的地进行分组转发的情况下，路由器的行为。
**转发表并不像我们直觉所料想的那样，是一个个完整的 IP 地址分别对应特定的输出端口。**存储所有 IP 地址并一一对应端口不可取，因为 IP 地址太多了，有 256 ^ 4 个。

路由器会为输出端口划分 IP 范围。实现上，每个链路端口会对应一个不完整的 IP 地址，表示这个端口接受的 IP 地址范围。
根据分组的目的地，与每个端口的 IP 范围进行匹配，将分组转发入最相同前缀最长的端口。

todo 假装这里有图片，四个端口分别对应的前缀

为实现纳米级别的转发，需要发展出对大型转发表能够做到线性时间查找的技术。
todo 了解一下快速查找算法
一方面开发出了快速查找算法。
另一方面，在嵌入式芯片中使用了以下缓存技术。
DRAM SRAM TCAM（三态...后面不记得了）

以下内容为扩展内容，可以跳过阅读。
> todo DRAM、SRAM、TCAM 是什么？快速查找算法是什么？

总的来说，在分组进入路由器到分组被转发出去这段时间内，路由器执行了四个动作：
* 按照分组的目的地指定输出端口，并将分组送入交换结构。
> 在某些设计中，如果交换结构中已有分组，则新分组会排队等待。
> 后续会仔细观察分组的阻塞、排队与调度。

* 检查分组版本号、校验和以及寿命字段，并重写后两个字段（4.3 节中将进行详细讨论）。

* 更新用于网络管理的计数器。

* 执行物理层与链路层交互。

## 交换结构
todo 三种交换方式的图

* 经内存交换
**最简单、最早的路由器是传统的计算机。**

 内存交换是指：
 当一个分组进入输入端口后，CPU 会将其复制入内存，然后由路由选择器为其指定一个输出端口。输出端口从内存中读取该分组后，分组从内存中删除。

 现代路由器也常常使用内存交换。但与上面讨论的内存交换方式不同的是，为分组指定输出端口的工作由线路卡代劳了。

* 经总线交换
总线交换是指：
所有输入端口和输出端口都通过一根总线相连。
分组在进入输入端口后，交换机会为其指定一个对应某个输出端口的内部地址，并将其送入总线。
所有输出端口都会收到这一分组，但只有地址对应的输出端口会接收这一分组。

 总线交换的效率受总线宽度的限制。

* 经纵横网络交换
纵横网络交换最大的优点就是在这种交换结构中，可以并行传输多个目的端口不冲突的分组。因此使用纵横网络交换的效率比经内存交换以及经总线交换要好得多。

 **分组在由主机和路由器组成的网络中的传播过程，可以抽象为分组经过纵横网络的过程。**


**以上讨论的三种交换方式，是通过对分组交换机中交换结构的抽象得来的。**

## 输出端口处理
输出端口处理包括以下过程：
1. 取出存放在输出端口内存中的分组。
2. 执行链路层和物理层操作。

## 什么时候会出现排队？
前面已经讨论过，在输入或输出端口都可能会出现排队。

分组排队会耗费路由器的内存。当路由器内存耗尽时，会出现丢包现象。

### 什么条件下，输入端口会出现排队？
**在交换结构的传输速率不远大于输入链路接受分组的速率时**，在输入端口会出现排队。

考虑纵横交换结构，假设有两个输入端口todo
todo 假装这里有图
在纵横交换结构中，有时会出现`线路前部阻塞（Head-of-line Blocking，HOL Blocking）`现象。这种阻塞有一个更广为人知的名字，叫`线头阻塞`或`队头阻塞`。
这种问题在缓存式交换机、TCP、HTTP中都可能出现。
https://zh.wikipedia.org/wiki/%E9%98%9F%E5%A4%B4%E9%98%BB%E5%A1%9E
具体解决吧

### 什么条件下，输出端口会出现排队？
多个输入端口同时接收到同一目的端口的分组。在输出端口会出现排队。

### 路由器如何选择丢弃哪个分组？
* 弃尾策略
* 在未满之前就丢弃分组或在分组上做标记，这样做的目的是向发送方提供拥塞信号。

### 如何计算路由器应具有多大的缓存？
为什么路由器要有缓存？
路由器缓存用于吸收流量负载的波动。

两个公式

## 分组调度
在输出端口缓存已满的情况下，需要选择优先输出哪个分组。这个过程称为`分组调度（packet scheduler）`

# 参考资料
* [队头阻塞](https://zh.wikipedia.org/wiki/%E9%98%9F%E5%A4%B4%E9%98%BB%E5%A1%9E)