---
title: 计算机网络：自顶向下方法读书笔记（四）
date: 2019-12-18 20:01:09
tags: [ 计算机网络, IP ]
---
本章我们来到了网络层。与运输层不同, 网络层存在于处在网络内部的每一台主机和路由器上。

网络层比较复杂, 可以分为两个相互独立但共同作用的部分: **数据平面**和**控制平面**。其基础协议是 IP 协议。本章主要涉及**网络层数据平面的相关知识。**

本章主要回答下面这些问题:
* 网络层数据平面的功能是什么?
* 路由器是如何实现网络层数据平面的功能的?
* 传统的基于 IP 的转发是如何实现的?
* 更为一般的转发是如何实现的?

# 网络层概述
我们将网络层使用的包称为`数据报(datagram)`。

网络层数据平面与控制平面的功能:
* 数据平面的功能: 转发。
* 控制平面的功能: 控制向哪里转发。这个功能还有一个高大上的名字, 叫路由选择。

`转发(forwarding)`和`路由选择(routing)`之间的区别是:
* **转发**指的是将一个数据报从一个链路转发到另一个链路的动作, 时间多为几纳秒, 通常用硬件来实现。
* **路由选择**是指确定数据报从发送端到接收端的路径的处理过程, 时间多为几秒, 通常用软件来实现。

为了实现控制平面的功能, 需要在路由器中存放一个`转发表(forwarding table)`。转发表会告知路由器具有特定首部值的数据报应该向哪条链路进行转发。

转发表一般有两种定义方式:
* 路由器与路由器之间通过路由选择协议交换包含路由信息的报文, 从而生成转发表。
在这种方式中, 路由器既实现了数据平面的功能, 也实现了控制平面的功能。
* 远程控制器计算转发表, 并向路由器进行分发。远程控制器存放在数据中心中, 由第三方或 ISP 进行管理。
通过这种方式, 路由器和远程控制器一起, 构成了一个实现了网络层所有功能的网络。由于这种网络的行为是通过远程控制器中的软件计算出来的, 因此将这样的网络称为`软件定义(的)网络(SDN, Software-Defined Networking)`。
在这种方式中, 路由器仅实现了数据平面的功能, 控制平面的功能由远程控制器实现。

**网络层提供的是尽力而为的服务(best-effort service)。**也就是说, 网络层不对数据报正确交付做任何承诺!

# 路由器工作原理
本节主要回答了路由器是如何将数据报从入链路转发到合适的出链路的。

## 路由器的结构
一个路由器的结构可以按照数据平面和控制平面来划分, 共分为四部分。
* 数据平面（由硬件实现）: 输入端口、交换结构、输出端口。
 要求纳秒级别, 因此无法用软件实现。
* 控制平面（由软件实现）: 路由选择处理器。

控制分组（如带有转发表信息的分组）由输入端口转发到路由选择处理器，路由选择器根据分组内容改变路由器行为。

## 基于目的地的分组转发
路由器转发一个分组时，会出现以下两种情况：
* 根据目的地转发。
* 根据其他通用的分组首部字段转发（通用分组转发）。

todo 补上 4.4 节的标题
**本节只讨论根据目的地转发分组的情况。**通用分组转发参见 4.4

如何避免每个分组进入输入端口后都调用一次路由选择处理器？
在交换结构与输入端口之间放置`线路卡`，路由选择处理器会将转发表复制到线路卡中。
当分组进入端口时，便可以根据线路卡中的转发表，在本地判断分组应该向哪个链路进行转发。

下面讨论在基于目的地进行分组转发的情况下，路由器的行为。
**转发表并不像我们直觉所料想的那样，是一个个完整的 IP 地址分别对应特定的输出端口。**存储所有 IP 地址并一一对应端口不可取，因为 IP 地址太多了，有 256 ^ 4 个。

路由器会为输出端口划分 IP 范围。实现上，每个链路端口会对应一个不完整的 IP 地址，表示这个端口接受的 IP 地址范围。
根据分组的目的地，与每个端口的 IP 范围进行匹配，将分组转发入最相同前缀最长的端口。

todo 假装这里有图片，四个端口分别对应的前缀

为实现纳米级别的转发，需要发展出对大型转发表能够做到线性时间查找的技术。
todo 了解一下快速查找算法
一方面开发出了快速查找算法。
另一方面，在嵌入式芯片中使用了以下缓存技术。
DRAM SRAM TCAM（三态...后面不记得了）

以下内容为扩展内容，可以跳过阅读。
> todo DRAM、SRAM、TCAM 是什么？快速查找算法是什么？

总的来说，在分组进入路由器到分组被转发出去这段时间内，路由器执行了四个动作：
* 按照分组的目的地指定输出端口，并将分组送入交换结构。
> 在某些设计中，如果交换结构中已有分组，则新分组会排队等待。
> 后续会仔细观察分组的阻塞、排队与调度。

* 检查分组版本号、校验和以及寿命字段，并重写后两个字段（4.3 节中将进行详细讨论）。

* 更新用于网络管理的计数器。

* 执行物理层与链路层交互。

## 交换结构
todo 三种交换方式的图

* 经内存交换
**最简单、最早的路由器是传统的计算机。**

 内存交换是指：
 当一个分组进入输入端口后，CPU 会将其复制入内存，然后由路由选择器为其指定一个输出端口。输出端口从内存中读取该分组后，分组从内存中删除。

 现代路由器也常常使用内存交换。但与上面讨论的内存交换方式不同的是，为分组指定输出端口的工作由线路卡代劳了。

* 经总线交换
总线交换是指：
所有输入端口和输出端口都通过一根总线相连。
分组在进入输入端口后，交换机会为其指定一个对应某个输出端口的内部地址，并将其送入总线。
所有输出端口都会收到这一分组，但只有地址对应的输出端口会接收这一分组。

 总线交换的效率受总线宽度的限制。

* 经纵横网络交换
纵横网络交换最大的优点就是在这种交换结构中，可以并行传输多个目的端口不冲突的分组。因此使用纵横网络交换的效率比经内存交换以及经总线交换要好得多。

 **分组在由主机和路由器组成的网络中的传播过程，可以抽象为分组经过纵横网络的过程。**


**以上讨论的三种交换方式，是通过对分组交换机中交换结构的抽象得来的。**

## 输出端口处理
输出端口处理包括以下过程：
1. 取出存放在输出端口内存中的分组。
2. 执行链路层和物理层操作。

## 什么时候会出现排队？
前面已经讨论过，在输入或输出端口都可能会出现排队。

分组排队会耗费路由器的内存。当路由器内存耗尽时，会出现丢包现象。

### 什么条件下，输入端口会出现排队？
**在交换结构的传输速率不远大于输入链路接受分组的速率时**，在输入端口会出现排队。

### 线头阻塞以及解决方法
如图。可以看到，最下面的端口中的第二个分组虽然不与最上面端口中的第一个分组目的地冲突，但由于最下面端口中第一个分组与最上面端口中的第一个分组目的地冲突，因此仍被延缓了发送。这种情况称为`线路前部阻塞（Head-of-line Blocking，HOL Blocking）`。

![线头阻塞](/images/computer-networking-a-top-down-approach-04/01.png)

在纵横交换结构中，有时会出现`线路前部阻塞（Head-of-line Blocking，HOL Blocking）`现象。这种阻塞有一个更广为人知的名字，叫`线头阻塞`或`队头阻塞`。
这种问题在缓存式交换机、TCP、HTTP中都可能出现。

那么线头阻塞的解决方法是什么？
关于 TCP 以及 HTTP 的解决方法可以参见前几章。这里只说明纵横式交换结构中线头阻塞的解决方法。
todo 在其他文件中补充 TCP 与 HTTP 线头阻塞的解决方法。
https://zh.wikipedia.org/wiki/%E9%98%9F%E5%A4%B4%E9%98%BB%E5%A1%9E

### 什么条件下，输出端口会出现排队？
多个输入端口同时接收到同一目的端口的分组。在输出端口会出现排队。

### 路由器如何选择丢弃哪个分组？
在输出端口缓存满之后，此时再有新的分组进来，路由器就需要决定丢弃哪个分组。

有两种策略用于解决这一问题。
* 弃尾策略：丢弃最后进来的分组。
* 在未满之前就丢弃分组或在分组上做标记，这样做的目的是向发送方提供拥塞信号。

### 如何计算路由器应具有多大的缓存？
路由器的缓存可以吸收链路上流量负载的波动。

通过两个公式可以计算链路上的路由器需要多大的缓存，才能适应链路的负载波动。

1. 经验公式（基于对少量 TCP 流的排队情况的动态分析得到）：
> B = RTT * C

 其中，`B` 为路由器缓存大小，`RTT` 为分组往返时间，`C` 为链路容量。

2. 具有大量 TCP 连接的链路：
> B = RTT * C / sqrt(N)

 其中，`N` 为链路中 TCP 连接的数量。

## 分组调度
在输出端口缓存已满的情况下，需要选择优先输出哪个分组。这个过程称为`分组调度（packet scheduler）`。
todo check mac 上有没有做笔记

## 网络协议：IPv4、寻址、IPv6及其他
### IPv4 数据报格式
网络层分组被称为`数据报`。

![数据报格式](/images/computer-networking-a-top-down-approach-04/02.png)

IPv4 中的关键字段如下：
- 版本：表示该数据报是 IPv4 格式还是 IPv6 格式。对于 IPv4 该值为 4。
- 首部长度：因为 IPv4 数据报首部中可包含一些数量可变的选项，首部的长度不是固定的，因此需要标识首部长度。大部分 IPv4 数据报首部都不包含选项，不包含选项的首部长度为 20 字节。
- `服务类型（TOS）`：区分不同类型的数据报，如一些数据报要求低延时、可靠性等。
- 数据报长度：数据报总长度，包括首部和数据，单位为字节。数据报最大理论长度为 65535 字节，不过一般很少有超过 1500 字节的。
- 标识、标志、片偏移：这三个字段与 IP 分片有关。**在 IPv6 协议中，不允许路由器对分组进行分片。**
- 寿命：即 TTL，指最大跳数。数据报每经过一个路由器，该值都会减一。当该值为 0 时，数据报会被丢弃。
- 协议：指明该数据报应该交付给哪种运输层协议。
- 首部检验和：计算方法为将首部中没两个字节作为一个数，取反码后再对所有数求和。**注意每个路由器都必须重新计算首部校验和并更改数据报，因为寿命和选项字段每经过一个路由器，都会发生变化。**
- 源和目的 IP 地址
- 选项：极少使用，且会带来额外的首部字段（首部长度），因此**在 IPv6 中移除了 IP 选项。**
- 数据

### IPv4 分片
#### IPv4 分片是什么？为什么需要 IPv4 分片？
承载 IP 协议的下层协议是链路层协议，链路层协议有很多种，每种链路层协议的容量也并不完全相同，一个链路层帧所能承载的最大数据量称为`最大传送单元（Maximum Transmission Unit, MTU）`。**一个数据报的数据量不能超出其下层链路层帧的所能承载的最大数据量。**
在数据报从源主机到目的主机的路径中，常常分布着不止一种链路层协议，因此需要对数据报进行拆分，以便其能够顺利通过链路层到达目的地。拆分后的数据报就称为`分片（fragment）`。

#### IPv4 分片的规则
分片工作通常是由路由器进行的。但**出于保持网络核心尽量简单的原则，路由器并不负责组装分片，分片的组装工作由目的主机完成。**

完成分片需要三部分，分别是`标识号`、`标志`以及`偏移量`。
在源主机生成数据报的时候，会对数据报打上标识号，每生成一个数据报，其标识号都会加一。
路由器在拆分数据报的时候，并不会改变数据报的标号。这样在目的主机收到分片后，能够确定其是否属于更大数据报的一部分，以及其具体属于哪个数据报。
路由器在拆分一个数据报时，会将最后一个分片的标志位置为 0，其他分片的标志位置为 1，以便目的主机确认自己收到了所有的分片。同时，路由器会给与每个分片不同的偏移量，以告知目的主机此分片处在数据报的哪个位置。

### IPv4 编址
#### 因特网的编址分配策略
因特网的的编址分配策略被称为`无类别域间路由选择（Classless Interdomain Routing， CIDR）[RFC  4632]`。
这种策略下的 IP 地址形式为 `a.b.c.d/x`，其中 `/x` 表示 IP 地址最左侧的 x 位为子网地址，因此 `/x` 也被称为`子网掩码（network mask）`。
而 IP 地址的前 x 位被称为该地址的`前缀（prefix）`或`网络前缀`。当子网外部的路由器判断是否需要向该子网的入口转发一个数据报时，只需要考虑地址的前缀是否匹配即可。
IP 地址中的剩余 32 - x 位是用于区分子网内部设备的，所有设备都具有相同的网络前缀。这些较低阶的比特也可以具有另外的子网结构。

举个例子，假如有一个三台机器构成的子网，其 IP 地址分别为 192.15.15.1/24、192.15.15.2/24、192.15.15.3/24，则该子网的子网掩码为 255.255.255.0，其网络前缀即为 192.15.15.*。

#### 另一种编址分配策略：分类编址（弃用）
在 CIDR 之前，IP 地址的网络部分被划分为 8、16、24 比特，并以此分为 A、B、C 类网络。

**目前这种分配策略已被弃用**。原因是因为其无法满足日渐膨胀的子网数量的需要，且这种分配策略常常会造成不必要的地址资源的浪费。

在这种地址分配策略中，B 类子网所能容纳的主机数量为 2^16 - 2 = 65534（两个地址预留用于特殊用途），而 C 类子网所能容纳的主机数量为 254。
这就导致在为一个组织分配地址时会陷入很尴尬的局面，C 类子网所能容纳的主机数量太少，不能很好的满足需要；而 B 类子网所能容纳的主机数量又太多，会导致不必要的地址资源的浪费。

#### 广播地址：255.255.255.255
当一台主机发出一个目的地址为 255.255.255.255 的数据报时，该报文会交付给同一个网络中的所有主机。路由器也会有选择地向相邻的子网转发该报文（虽然它们通常不这么做）。

#### 如何获得 IP 地址
获得 IP 地址分为两部分，对于一个组织来说，需要获取的是一个 IP 段；对于一个主机来说，需要获取的是一个 IP 地址。下面分别介绍。

##### 一个组织如何获取 IP 段？
当一个组织想要获取 IP 段为自己内部的设备所用时，一般只需要联系附近的 ISP 提供商即可。

那么 ISP 又是从哪里获取的 IP 段呢？
这就要说到一个非营利型的全球性组织：`因特网名字和编号分配机构（Internet Corporation for Assigned Names and Numbers，ICANN）`。这个组织基于 [RFC 7020](todo 链接) 管理 IP 地址，同时该组织还负责管理 DNS 根服务器，且负责分配域名和解决域名纷争。ICANN 会向`区域互联网注册机构（Regional Internet Registry，RIR）`分配地址，这些机构一起形成了 ICANN 的地址支持组织，每个机构负责处理本区域的地址分配和管理。

中国的 IP 网段管理组织为`亚太互联网络信息中心（Asia-Pacific Network Information Centre，APNIC）`。全球共有五大区域互联网，分别为：
- `美洲互联网号码注册管理机构（American Registry for Internet Numbers，ARIN）`：管理北美、南极洲和部分加勒比地区事务。
- `欧洲 IP 网络资源协调中心（RIPE Network Coordination Centre，RIPE NCC）`：管理欧洲、中东和中亚地区事务。
- `亚太网络信息中心（Asia-Pacific Network Information Centre，APNIC）`：管理亚洲和太平洋地区事务。
- `拉丁美洲及加勒比地区互联网地址注册管理机构（Latin American and Caribbean Internet Address Registry，LACNIC）`：管理拉丁美洲和部分加勒比地区事务。
- `非洲网络信息中心（African Network Information Centre，AfriNIC）`：管理非洲事务。

##### 一台主机如何获取 IP 地址？
某个组织在得到了 IP 段之后，就可以开始着手为组织内的路由器和主机分配 IP 地址了。这种分配工作可以手动完成，但这样效率低下，且工作繁重，因此我们更多的是通过`动态主机配置协议（Dynamic Host Configuration，DHCP）[RFC 2131](todo 链接)`来自动完成 IP 地址的分配的。通过 DHCP 协议，主机可以自动获取一个 IP 地址。网络管理员可以通过配置 DHCP，确保某台主机每次与网络连接时都能得到固定的 IP 地址。DHCP 也可以为主机分配临时 IP 地址，这种情况下每次主机与网络相连时，获取的 IP 都不相同。**除了 IP 地址以外，DHCP 还会告诉主机子网掩码、 DNS 服务器地址和第一跳路由器的地址（默认网关）等其他信息。**

要想在子网中启用 DHCP 服务，首先需要至少一台 DHCP 服务器。如果子网中没有 DHCP 服务器，则需要一个 DHCP 中继代理（一般是一个路由器），这个代理知道用于该子网的 DHCP 服务器的地址。

todo 最好有张 4-23 的图

在一台主机连接到子网后，需要 4 步来获取 IP 地址：
1. **发现 DHCP 服务器**：这需要用到 `DHCP 发现报文（DHCP discover message）`。主机首先会通过 UDP 向 67 端口发送该报文。在此时，由于主机未分配 IP 地址，且主机也不知道 DHCP 的 IP 地址，因此**其 IP 数据报的源地址为 0.0.0.0，而目标地址为 255.255.255.255（广播地址）。**
2. **提供 DHCP 服务**：DHCP 服务器在收到发现报文后，会使用 `DHCP 提供报文（DHCP offer message）`向主机发出响应。**该报文仍需要向子网中的所有主机进行广播，因此其 IP 地址仍为 255.255.255.255。**DHCP 提供报文中包含有发现报文的事务 ID、主机被分配的 IP 地址、子网掩码以及 `IP 地址租用期（address lease time）`，即 IP 地址的有效期。
3. **DHCP 请求**：主机在收到 DHCP 提供报文后，向 DHCP 服务器发送 `DHCP 请求报文（）`，回显配置参数。如果子网中存在多个 DHCP 服务器，主机会收到多个 DHCP 提供报文，这时主机会从中任意选择一个向其发送 DHCP 请求报文。
4. **DHCP 请求确认**：DHCP 服务器用 `DHCP 确认报文（）`对 DHCP 请求报文进行响应，确认主机的配置。

todo 最好有张 4-24 的图

DHCP 还提供了一种更新机制，用于让主机在 IP 地址过期后重新获取 IP 地址。具体更新机制在下面介绍。

DHCP 虽然配置十分便利，但从移动性的角度来说，其弊端十分明显。每当主机连接到一个新子网，就必须重新获取一个新的 IP 地址；当主机在子网之间移动时，就不能维持与远程应用之间的 TCP 连接。

#### 补充知识
#### 关于 IP 地址租用期
在网络上提供服务的系统应保留它们的 IP 地址。这类系统不应受短期租用的限制。如果为这类系统指定保留的手动 IP 地址而不是永久租用的 IP 地址，则可以在这些系统中使用 DHCP。然后，可以检测何时不再使用系统的 IP 地址。
https://docs.oracle.com/cd/E19253-01/819-7058/dhcptm-1/index.html

##### 当一台连接到某个子网的主机使用的 IP 地址过期后，如何获得新的 IP 地址？
todo DHCP 如何更新主机 IP
https://docs.oracle.com/cd/E19253-01/819-7058/dhcptm-1/index.html
##### 企业级的使用用户名和密码登录的 wifi 是如何搭建的？
https://zhuanlan.zhihu.com/p/28439127
https://zhuanlan.zhihu.com/p/28927420
todo

### 网络地址转换
随着子网数量和主机设备的不断增加，一台主机对应一个公网 IP 是必然不现实的事，那么解决办法是什么呢？

解决办法就是，为子网内的主机分配只在子网内部有效的 IP 地址而不是为其分配公网 IP，在主机发送包时，通过某种转换机制，将内部 IP 转换为公网 IP 进行发送。这种管理 IP 地址的方法称为`网络地址转换（Network Address Translation，NAT）`。

**要想实现 NAT，我们首先需要在子网中假设一台具有 NAT 功能的路由器**，这个路由器一端连接着互联网，一端连接着子网。连接到子网中的主机发送的包，都要经过此路由器转发至互联网。**这个路由器同时还需要具有 DHCP 服务器的功能**，负责为子网中的主机分配`专用网络（private network）`IP，这种 IP 仅对于连接到该子网内的设备有意义。为了避免与公网 IP 冲突，分配专用网络 IP 时只能使用 [RFC 1918](todo) 中规定的预留的 IP 段：

| IP 地址区块 | IP 数量 | 子网掩码 |
|--|--|--|
|10.0.0.0 – 10.255.255.255|16,777,216|10.0.0.0/8 (255.0.0.0)|
|172.16.0.0 – 172.31.255.255|1,048,576|172.16.0.0/12 (255.240.0.0)|
|192.168.0.0 – 192.168.255.255|65,536|192.168.0.0/16 (255.255.0.0)|

#### NAT 工作原理
todo 图 4-25

现在让我们来看看 NAT 具体是如何工作的。

为了实现转换，NAT 路由器上会维护一张`NAT 转换表（NAT translation table）`，表中记录了子网发送到 NAT 路由器的数据报中的源地址、源端口号和目的地址，以及修改后的端口号。

内网发送的数据报会首先被发送到 NAT 使能路由器中。在收到内网中的主机发送的数据报后，路由器会对数据报的两个部分进行修改：
* **将数据报的源地址改为路由器的公网 IP**，并记录下修改前的数据报中的源地址和目的地址。
* **修改数据报的源端口号**，并记录下原来的端口号和修改后的端口号。需要注意的是，**修改后的端口号必须是当前未在 NAT 转换表中的的端口号。**

在进行完上述修改后，路由器会将数据报发送出去，就像一台主机一样。服务器收到请求后，并不知道这个包是已经被修改过的，因此会向路由器发出响应。**路由器在收到响应后，会根据响应的源地址和目的端口号在 NAT 转换表中检索出该包要转发到哪个主机**，然后据此修改响应数据报，并将响应数据报转发到对应主机。

从上面的例子中我们也可以看到，NAT 功能一般架设在子网出口的位置，与网关的位置一致。**在实现时，可以考虑直接在 NAT 网关上实现 NAT 功能。**

这里还有一个小问题，我们注意到 NAT 路由器同时肩负了子网的 DHCP 服务器功能，那 NAT 路由器的 IP 地址是怎么被分配的呢？答案也是 DHCP 分配的，只不过 NAT 路由器的 IP 地址是从 ISP 的 DHCP 服务器中获得的，而子网中设备的 IP 是由路由器的 DHCP 服务器分配的。

#### NAT 的反对者们
NAT 确实解决了很多问题，但同时也不乏反对的声音。

一种观点认为，端口号应该只被用于进程寻址，而不应被用于主机寻址。这种违规用法对于运行在家庭网络中的服务器来说确实会有问题。常见的解决办法有 `NAT 穿越（NAT traversal）`工具[RFC 5389](todo 链接)以及`通用即插即用（Universal Plug and Play，UPnP）`。

另一种观点认为，路由器是第三层（网络层）的设备，因此只应当处理到达网络层的分组。NAT 违反了主机间应该直接对话的原则，其应当让主机对数据报进行修改，而不是由路由器进行修改。个人认为，这种意见没有什么参考价值，因为其过于教条主义，并没有提出实质上的更为简单的解决方案。

#### 小结
无论如何，NAT 已经成为了重要的网络组成部分，成为了所谓的`中间盒`。
中间盒运行在网络层中，并具有与路由器十分不同的功能，其并不进行数据报转发，而是执行如 NAT、负载均衡、防火墙的功能，在当今网络中起着至关重要的作用。

#### 补充知识
##### NAT 穿越工具及原理
todo 
##### 通用即插即用
todo 
UPnP 是一种允许主机发送和配置临近 NAT 的协议。

### IPv6
由于 32 bit 的 IPv4 空间即将耗尽，因此开发了一种大容量的 IP 协议：IPv6 [[RFC 2460]](todo 2460)。

#### IPv6 数据报格式
todo 图

- 版本：IPv6 协议该值为 6。**注意，仅仅将该值置为 4 并不能得到一个合法的 IPv4 数据报。**
- 流量类型：该 8 bit 字段含义与 IPv4 的服务类型字段相似。
- 流标签：该 20 bit 的字段用于标识一条数据报的流，能够对一条流中的某些数据报给出优先权，或使某些应用的数据报与其他应用相比具有更高优先权。
- 有效载荷长度：16 bit 无符号整数，单位 byte。
- 下一个首部：数据报应该被交付给哪个运输层协议，使用的值与 IPv4 数据报中的协议字段相同。
- 跳限制：与 IPv4 数据报中的寿命字段相同。
- 源地址和目的地址：均为 128 bit，与 IPv4 相比大大增长。详细定义见 [[RFC 4291]](todo)
- 数据：有效载荷。

#### IPv6 数据报与 IPv4 数据报的对比
在来看 IPv6 与 IPv4 的具体区别之前，我们需要知道 IP 协议关注的重点是什么。**IP 协议关注的重点是快速处理 IP 分组**。这种快速处理主要指的是路由器对于 IP 分组的快速处理，以便 IP 分组能够更快的被转发出去，提升 IP 协议的效率。知晓了这一点，我们便能明白为什么 IPv6 要做这些变化了。

首先我们来看 IPv6 与 IPv4 的相比增加的东西。
- 大大增长的地址容量：由 IPv4 的 32 bit 变为 128 bit。
- 引入`任播地址（anycast address）`：这种地址允许将数据报交付给一组主机中的任意一个。比如向保存某个文档的一系列镜像站点中最近的一个发送 HTTP GET 报文。
- 固定的 40 byte 首部。
- 流标签：前面已经说过了，流标签可以使某些数据报获取比其他数据报更高的优先级，以获得更好的实时性体验。

接下来我们看看 IPv6 与 IPv4 相比，在数据报中移除的字段。
- 分片/重新组装：**IPv6 不允许路由器进行分片和重新装配，所有分片和重新组装的工作只能在源主机和目的主机中进行**。如果数据报不足以通过链路层，则路由器会丢弃该数据报，并向源主机发送一个 “数据报过长” 的 ICMP 差错报文（详情见 5.6 节）。
- 首部校验和：由于运输层和数据链路层都做了校验操作，因此在网络层再进行校验未免有些多余。同时由于寿命/跳限制字段的存在，路由器需要每次都重新计算首部校验和，去除该字段也减轻了路由器的负担。
- 选项：选项字段不再是标准 IP 数据报首部的一部分，但其并没有消失，而是出现在了`下一个首部`字段。**正如运输层协议的首部可能成为下一个首部一样，选项字段也可以是下一个首部**。移除该字段可以将数据报的首部固定为 40 byte。

移除这些字段都是为了减轻数据报在传输过程中路由器需要做的工作，以便数据报更快的传输。

#### IPv4 到 IPv6 的迁移
现在我们需要面临一个十分实际的问题：如何将 IPv4 迁移到 IPv6 呢？虽然已经部署的 IPv6 系统支持发送和处理 IPv4 的数据报，但之前部署的 IPv4 系统却并不支持 IPv6。对于这个问题，主要有两个解决方法。

第一种是宣布一个日期，届时所有的互联网机器都将关机并从 IPv4 升级的 IPv6。仅仅是说说就已经足够好笑了，你不可能要求一个具有数十亿机器的网络关机，因此**这条路肯定是行不通的。**

幸运的是我们还有一种解决方法，叫做`建隧道（tunneling）`[[RFC 4213]](todo)。

todo 4-27

考虑上图中的网络。可以看到两个 IPv6 节点之间的网络是通过 IPv4 路由器互联的，我们将两个 IPv6 路由器中间的 IPv4 路由器网络称为`隧道（tunnel）`。
在隧道发送端，**路由器将整个 IPv6 数据报放入一个 IPv4 数据报的有效载荷中，并将其协议号置为 41**，表示这是一个具有 IPv6 数据报作为有效载荷的 IPv4 数据报。
在隧道接收端，路由器会检查 IPv4 数据报的协议号，发现其协议号为 41 后，便从中取出 IPv6 数据报，然后再为 IPv6 数据报提供路由。

#### 小结
可以看到，虽然应用层协议经历了多次更新，但网络层协议作为整个互联网的基础，要想改变它是十分困难的。

#### 补充知识
todo 单播地址、多播地址、任播地址

## 通用转发和 SDN


# 参考资料
* [队头阻塞](https://zh.wikipedia.org/wiki/%E9%98%9F%E5%A4%B4%E9%98%BB%E5%A1%9E)
* [wikipedia: 专用网络](https://zh.wikipedia.org/wiki/%E4%B8%93%E7%94%A8%E7%BD%91%E7%BB%9C)